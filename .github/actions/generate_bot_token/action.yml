name: "Generate bot token"
inputs:
  bot_pem:
    description: "The private key which identfies the bot"
    required: true
outputs:
  installation_token:
    description: "The token which will allow you to authentificate as the GitHub app for 1 hour"
    value: ${{ steps.get_token.outputs.token }}

runs:
  using: "composite"
  steps:
    - run: |
        pip install jwt requests
      shell: bash
    - run: |
        echo "$PEM" > bot.pem
        cat bot.pem
      shell: bash
      env:
        PEM: ${{ inputs.bot_pem }}
    - run: |
        import jwt
        import time
        import os
        import requests
        with open("bot.pem", "rb") as f:
            v = f.read()
            print(v[:10])
            signing_key = jwt.jwk_from_pem(v)
        v = os.environ["PEM"]
        print(v[:10])
        # Issued at time
        # JWT expiration time (10 minutes maximum)
        # GitHub App's identifier
        payload = {'iat': int(time.time()), 'exp': int(time.time()) + 60, 'iss': 337566}

        jw_token=jwt.JWT().encode(payload, signing_key, alg='RS256')

        print(jw_token[:10])

        headers = {"Accept": "application/vnd.github+json", "Authorization": f"Bearer {jw_token}", "X-GitHub-Api-Version": "2022-11-28"}

        reply = requests.post("https://api.github.com/app/installations/37820767/access_tokens", headers=headers)

        print(reply.text)
        print(reply.json())

        t = reply.json()["token"]
        print(t[:10])

        # Create JWT
        with open("${{ github.output }}", 'a') as f:
            print("token=", reply.json()["token"], sep='', file = f)
      shell: python
      id: get_token
      env:
        PEM: ${{ inputs.bot_pem }}
    - run:
        echo "${{ steps.get_token.outputs.token }}"
      shell: bash
