# After changing this file, check it on:
#   http://lint.travis-ci.org/

language: python
os: linux
dist: xenial

jobs:
  include:

#  - os: linux
#    python: 3.5
#    before_install: bash .travis/before_install.sh
#
#  - os: linux
#    python: 3.6
#    before_install: bash .travis/before_install.sh

  - os: linux
    python: 3.7
    before_install: bash .travis/before_install.sh

  - os: windows
    language: c  # Python not supported, "language: generic" doesn't start VM
    before_install:
    - choco install anaconda3
    - ls -l /c/tools/anaconda3/condabin
    - ls -l /c/tools/anaconda3/etc
    - source /c/tools/Anaconda3/etc/profile.d/conda.sh
    - source .travis/RefreshEnv.sh
    - conda activate
    - conda config --show
    - which python
    - python -VV
    - which gfortran
    - gfortran --version
    #
    # Download MS MPI runtime and SDK
    - curl -L https://github.com/microsoft/Microsoft-MPI/releases/download/v10.1.1/msmpisetup.exe -o msmpisetup.exe
    - curl -L https://github.com/microsoft/Microsoft-MPI/releases/download/v10.1.1/msmpisdk.msi -o msmpisdk.msi
    #
    # Install MS MPI
    - ./msmpisetup.exe -unattend
    - sleep 5
    - msiexec //quiet //i msmpisdk.msi
    - refreshenv
    #
    # Generate mpi.mod for gfortran according to https://abhilashreddy.com/writing/3/mpi_instructions.html
    - cd "$MSMPI_INC"
    - sed -i 's/mpifptr.h/x64\/mpifptr.h/g' mpi.f90
    - sed -i 's/mpifptr.h/x64\/mpifptr.h/g' mpif.h
    - gfortran -c -D_WIN64 -D INT_PTR_KIND\(\)=8 -fno-range-check mpi.f90
    - cd -

install:
  - pip install .

before_script:
  - pip install pytest
  - pip install coverage
  - pip install mpi4py
  - INSTALL_DIR=$(python -c "import pyccel; print(pyccel.__path__[0])")
  - SITE_DIR=$(python -c 'import sysconfig; print(sysconfig.get_paths()["purelib"])')
  - echo -e "import coverage; coverage.process_startup()" > ${SITE_DIR}/pyccel_cov.pth
  - echo -e "[run]\nparallel = True\nsource = ${INSTALL_DIR}\n[report]\ninclude = ${INSTALL_DIR}/*\n[xml]\noutput = cobertura.xml" > .coveragerc
  - export COVERAGE_PROCESS_START=$(pwd)/.coveragerc

script:
  - python -m pytest tests -m "not parallel" --ignore=tests/ast --ignore=tests/printers --ignore=tests/symbolic
  - mpiexec -n 4 python -m pytest tests/epyccel/test_epyccel_mpi_modules.py -v -m parallel
#  - mpiexec -n 4 python -m pytest tests/epyccel -v -m parallel

after_script:
  - coverage combine
  - coverage xml
  - rm ${SITE_DIR}/pyccel_cov.pth
  - bash <(wget -q -O - https://coverage.codacy.com/get.sh)
